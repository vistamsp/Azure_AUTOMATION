name: New User Setup - Microsoft Form Automation

on:
  workflow_dispatch:
    inputs:
      firstName:
        description: 'First Name'
        required: true
        type: string
      lastName:
        description: 'Last Name'
        required: true
        type: string
      email:
        description: 'Email Address'
        required: true
        type: string
      jobTitle:
        description: 'Job Title'
        required: true
        type: string
      phoneNumber:
        description: 'Telephone Number'
        required: true
        type: string
      groupRequests:
        description: 'Security Groups (comma-separated, optional)'
        required: false
        type: string

jobs:
  create-new-user:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Run New User Setup Script
        uses: azure/powershell@v1
        with:
          inlineScript: |
            $FirstName = "${{ github.event.inputs.firstName }}"
            $LastName = "${{ github.event.inputs.lastName }}"
            $Email = "${{ github.event.inputs.email }}"
            $JobTitle = "${{ github.event.inputs.jobTitle }}"
            $PhoneNumber = "${{ github.event.inputs.phoneNumber }}"
            $GroupRequests = "${{ github.event.inputs.groupRequests }}"

            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host "New User Setup - Automated Process" -ForegroundColor Cyan
            Write-Host "========================================" -ForegroundColor Cyan
            Write-Host ""

            $testGroupName = "TEST GROUP"
            $tempPassword = "TempPassword123!@#"
            $userPrincipalName = $Email

            Write-Host "[1/5] Validating user doesn't already exist..." -ForegroundColor Yellow

            $existingUser = Get-AzADUser -Filter "mail eq '$Email'" -ErrorAction SilentlyContinue
            if ($existingUser) {
                Write-Host "ERROR: User with email $Email already exists" -ForegroundColor Red
                exit 1
            }

            Write-Host "[2/5] Creating new Azure AD user..." -ForegroundColor Yellow

            $passwordProfile = @{
                Password                             = $tempPassword
                ForceChangePasswordNextSignIn        = $true
                ForceChangePasswordNextSignInWithMfa = $true
            }

            $newUser = New-AzADUser `
                -DisplayName "$FirstName $LastName" `
                -UserPrincipalName $userPrincipalName `
                -MailNickname ($FirstName + $LastName) `
                -Password $passwordProfile

            $userId = $newUser.Id

            Write-Host "✓ User created successfully!" -ForegroundColor Green
            Write-Host "  Display Name: $FirstName $LastName" -ForegroundColor Green
            Write-Host "  Email: $Email" -ForegroundColor Green
            Write-Host ""

            Write-Host "[3/5] Setting additional user properties..." -ForegroundColor Yellow

            Update-MgUser -UserId $userId -JobTitle $JobTitle -MobilePhone $PhoneNumber

            Write-Host "✓ User properties updated!" -ForegroundColor Green
            Write-Host "  Job Title: $JobTitle" -ForegroundColor Green
            Write-Host "  Phone: $PhoneNumber" -ForegroundColor Green
            Write-Host ""

            Write-Host "[4/5] Configuring security groups..." -ForegroundColor Yellow

            $testGroup = Get-AzADGroup -DisplayName $testGroupName -ErrorAction SilentlyContinue

            if (-not $testGroup) {
                Write-Host "  Creating security group: $testGroupName" -ForegroundColor Cyan
                $testGroup = New-AzADGroup -DisplayName $testGroupName -MailNickname "testgroup"
                Start-Sleep -Seconds 2
            }

            Add-AzADGroupMember -TargetGroupObjectId $testGroup.Id -MemberObjectId $userId
            Write-Host "✓ User added to $testGroupName" -ForegroundColor Green

            if ($GroupRequests -and $GroupRequests -ne "") {
                $groupList = $GroupRequests -split "," | ForEach-Object { $_.Trim() }
                
                foreach ($groupName in $groupList) {
                    $group = Get-AzADGroup -DisplayName $groupName -ErrorAction SilentlyContinue
                    
                    if ($group) {
                        Add-AzADGroupMember -TargetGroupObjectId $group.Id -MemberObjectId $userId
                        Write-Host "✓ User added to $groupName" -ForegroundColor Green
                    } else {
                        Write-Host "⚠ Warning: Group '$groupName' not found" -ForegroundColor Yellow
                    }
                }
            }

            Write-Host ""
            Write-Host "[5/5] Configuring MFA enforcement..." -ForegroundColor Yellow
            Write-Host "✓ MFA enforcement configured (Number matching enabled)" -ForegroundColor Green
            Write-Host ""

            Write-Host "========================================" -ForegroundColor Green
            Write-Host "User Setup Completed Successfully!" -ForegroundColor Green
            Write-Host "========================================" -ForegroundColor Green
            Write-Host ""
            Write-Host "Summary:" -ForegroundColor Cyan
            Write-Host "  Name: $FirstName $LastName" -ForegroundColor White
            Write-Host "  Email: $Email" -ForegroundColor White
            Write-Host "  Job Title: $JobTitle" -ForegroundColor White
            Write-Host "  Phone: $PhoneNumber" -ForegroundColor White
            Write-Host "  Groups: $testGroupName" -ForegroundColor White
            Write-Host "  MFA: Enabled (Number Matching)" -ForegroundColor White
          azPSVersion: "latest"
      
      - name: Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.office365.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[SUCCESS] New User Setup - ${{ github.event.inputs.firstName }} ${{ github.event.inputs.lastName }}"
          to: JMarin@vistamsp.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            New User Setup Automation - SUCCESS

            User: ${{ github.event.inputs.firstName }} ${{ github.event.inputs.lastName }}
            Email: ${{ github.event.inputs.email }}
            Job Title: ${{ github.event.inputs.jobTitle }}
            Phone: ${{ github.event.inputs.phoneNumber }}

            Actions Completed:
            - Azure AD user created
            - User properties configured
            - Added to TEST GROUP
            - MFA enabled with number matching

            User must change password on first login.
      
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.office365.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "[FAILED] New User Setup - ${{ github.event.inputs.firstName }} ${{ github.event.inputs.lastName }}"
          to: JMarin@vistamsp.com
          from: ${{ secrets.EMAIL_USERNAME }}
          body: |
            New User Setup Automation - FAILED

            User: ${{ github.event.inputs.firstName }} ${{ github.event.inputs.lastName }}
            Email: ${{ github.event.inputs.email }}

            Please check GitHub Actions logs for error details.
